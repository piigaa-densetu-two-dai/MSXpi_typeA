i8251ファームウェアです。
このファームウェアを書き込んだMSXπはPC側からはUSB-CDCデバイス、MSX側からは拡張IOポートに接続されたi8251に見えます。PC-MSX間でUSB通信できます。

ご注意
PCとの通信時はD+,D-,GNDのみが結線されたUSBケーブル(VCCの配線を切断したUSBケーブル)を使用する必要があります。売っていないので工夫して作って下さい。普通のUSBケーブルは絶対に使用しないで下さいパソコンが大爆発します。

使用法

1. MSXに刺さっていない状態のMSXπをブートモードでPCに接続します。

MSXπのBOOTSELボタンを押しながらPCとUSB接続して下さい。
接続が成功するとドライブが認識されます。

2. MSXπにi8251.uf2を書き込みします。

1で認識されたドライブにi8251.uf2をドラッグアンドドロップ(コピー)します。
コピーが完了するとドライブが見えなくなります。

3. 書込みが終わったらPCから外して完了

注意：PCとの接続中はバスバッファの入力がフロート状態となります。
あまり良い状態ではないので長時間のPC接続は避けてください。


機能詳細

CDCシリアルポートに書き込んだデータが疑似i8251の受信ポートに、疑似i8251の送信ポートに書き込んだデータがCDCシリアルポートに送信されます。

PC側の設定
接続が確立されると自動的にUSB-CDCとして認識されると思います。
シリアルポートの設定はデフォルト設定のままで構いません。通信はUSBで完結しているので速度やパリティ等の設定は意味を持ちません。

MSXからの使用法
拡張IOポートの仕様に従っています(ベンダー0x69)
ポート0x40に0x69を書くと有効、0x69以外を書くと無効になります。
起動・リセット時の初期状態は無効状態です。

無効時
0x40(write)	0x69を書き込むと有効、0x69以外の書込みは無視(無効のまま)

有効時
0x40(write)	0x69以外の書込みで無効、0x69の書込みは無視(有効のまま)
0x40(read)	0x96(0x69のビット反転値)を返す。これによりボードの有無を判定できます。
0x41(write)	i8251設定(無視します・USB接続なので設定は無意味)
0x41(read)	i8251状態を返す
0x42(write)	i8251書込み
0x42(read)	i8251読み出し

i8251状態
D7      D6      D5      D4      D3      D2      D1      D0
1固定   0固定   0固定   0固定   0固定   TXEMPTY RXRDY   TXRDY

TXEMPTY送信バッファが空で1
RXRDY受信データがあると1
TXRDY送信可能(送信バッファに空きがある)で1

送信(受信)は必ずTXRDY(RXRDY)が1である事を確認してから行なう事。
